#!/bin/bash

set -e

# bash script to create gif from avi
# usage:
#   ./make_gif.sh filename start_time length width lossy

file=$1
start=$2
length=$3
width=${4:-1200}
lossy=${5:-20}
palette="/tmp/palette.png"
filters="fps=30,scale=$width:-1:flags=lanczos"

dir=$(dirname $file)
filename=$(basename -- "$file")
extension="${filename##*.}"
filename="${filename%.*}"

# echo params to terminal
echo "$file $start $length $width $lossy"

if [ -z "$start$length" ]; then
  ## From https://superuser.com/a/556031
  ffmpeg -i $file \
      -vf "fps=30,scale=$width:-1:flags=lanczos,split[s0][s1];[s0]palettegen=stats_mode=diff[p];[s1][p]paletteuse=dither=none" \
      -loop 0 "$dir/$filename-raw.gif"
elif [ -z "$length" ]; then
  ffmpeg -ss $start -i $file \
      -vf "fps=30,scale=$width:-1:flags=lanczos,split[s0][s1];[s0]palettegen=stats_mode=diff[p];[s1][p]paletteuse=dither=none" \
      -loop 0 "$dir/$filename-raw.gif"
else
  ffmpeg -ss $start -t $length -i $file \
      -vf "fps=30,scale=$width:-1:flags=lanczos,split[s0][s1];[s0]palettegen=stats_mode=diff[p];[s1][p]paletteuse=dither=none" \
      -loop 0 "$dir/$filename-raw.gif"
fi

# optimize gif
gifsicle -O3 "$dir/$filename-raw.gif" --lossy=$lossy -o "$dir/$filename.gif"

rm "$dir/$filename-raw.gif"

osascript -e "display notification \"$1 successfully converted and saved\" with title \"Video 2 Gif SUCCESS!\""

